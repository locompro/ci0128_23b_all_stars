@page
@using Locompro.Models.Entities
@using Locompro.Services.Domain
@using Locompro.Services.Auth
@model ProfileModel
@inject INamedEntityDomainService<Country, string> CountryService
@inject IAuthService AuthService
@{
    var userId = AuthService.GetUserId();
    ViewData["Title"] = "Perfil";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<div class="text-center d-lg-flex justify-content-lg-center">

<div class="container flex-shrink-1 flex-fill justify-content-center align-items-center align-content-center ">
<div class="row" id="UserIconRow">
    <div class="col d-lg-flex justify-content-lg-center">
        <div class="bs-icon-xl bs-icon-circle bs-icon-primary text-center d-inline-flex d-lg-flex bs-icon my-4"
             id="UserIcon">
            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor"
                 viewBox="0 0 16 16" class="bi bi-person-fill text-center d-lg-flex justify-content-lg-center"
                 style="font-size: 40px;">
                <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3Zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"></path>
            </svg>
        </div>
    </div>
</div>
<div class="row" style="margin-bottom: 30px" id="UsernameRow">
    <div class="col">
        <h2 class="d-xxl-flex justify-content-xxl-center" id="UserName">@Model.UserProfile.Username</h2>
        <h4 class="text-secondary" id="Name">@Model.UserProfile.Name</h4>
    </div>
</div>

<div class="row" id="UserEmailRow">
    <div class="col">
        <h4>Correo</h4>
        <p class="d-xl-flex justify-content-xl-center" id="Email">@Model.UserProfile.Email</p>
    </div>
</div>

<div class="row d-xl-flex justify-content-xl-center" id="AddressRow">
    <div class="col-xl-7">
        <h4>Dirección</h4>
        <p class="d-xl-flex justify-content-xl-center" id="Address">@Model.UserProfile.Address</p>
    </div>
</div>
<div class="row" id="UserStatsRow">
    <div class="col justify-content-right">
        <div class="text-center d-flex flex-column justify-content-center align-items-center py-3"
             style="margin-right: 0">
            <div class="bs-icon-md bs-icon-circle bs-icon-primary d-flex flex-shrink-0 justify-content-center align-items-center d-inline-block mb-2 bs-icon lg"
                 id="ContributionsIcon">
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor"
                     viewBox="0 0 16 16" class="bi bi-journal-check" style="font-size: 32px;">
                    <path fill-rule="evenodd"
                          d="M10.854 6.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 8.793l2.646-2.647a.5.5 0 0 1 .708 0z">
                    </path>
                    <path
                        d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2z">
                    </path>
                    <path
                        d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1z">
                    </path>
                </svg>
            </div>
            <div class="px-3">
                <h4 class="fw-bold mb-0" id="Contributions">@Model.UserProfile.Contributions</h4>
                <p class="mb-0">Contribuciones</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="text-center d-flex flex-column justify-content-center align-items-center py-3"
             style="margin-left: 0">
            <div class="bs-icon-md bs-icon-circle bs-icon-primary d-flex flex-shrink-0 justify-content-center align-items-center d-inline-block mb-2 bs-icon lg"
                 id="RatingIcon">
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor"
                     viewBox="0 0 16 16" class="bi bi-star-fill">
                    <path
                        d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z">
                    </path>
                </svg>
            </div>
            <div class="px-3">
                <h4 class="fw-bold mb-0" id="Rating">@Model.UserProfile.Rating</h4>
                <p class="mb-0">Calificación</p>
            </div>
        </div>
    </div>
</div>
<div class="row" id="UserActionsRow">
     <div class="col d-xxl-flex justify-content-xxl-end">
        <a class="btn btn-primary text-center border rounded-pill d-xxl-flex flex-grow-0 flex-shrink-1 justify-content-xxl-start"
                role="button" asp-page="/SearchResults/Contributions" asp-route-query="@userId" id="Contributions">
            Mis Contribuciones
        </a>
    </div>
    <div class="col">
        <button class="btn btn-primary border rounded-pill d-xxl-inline-flex"
                style="padding-left: 31px;padding-right: 31px;" type="button" data-bs-target="#UpdateUserDataModal"
                data-bs-toggle="modal" id="UpdateUserDataButton">
            Modificar Perfil
        </button>
    </div>
    <div class="col">
        <button
            class="btn btn-primary text-center border rounded-pill d-xxl-flex flex-grow-0 flex-shrink-1 justify-content-xxl-start"
            type="button" data-bs-target="#ChangePasswordModal" data-bs-toggle="modal"
            id="ChangePasswordButton">
            Cambiar Contraseña
        </button>
    </div>
</div>
<br>
@if (Model.IsModerator)
{
    <div class="row" id="ModerationAction">
        <div class="col d-xxl-flex justify-content-xxl-center">
            <button class="btn btn-primary critical-button border rounded-pill d-xxl-inline-flex"
                    style="padding-left: 31px;padding-right: 31px;" type="button"
                    data-bs-target="#DeclineModerationRoleModal" data-bs-toggle="modal"
                    id="DeclineModerationRoleButton">
                Renunciar a
                Moderación
            </button>
        </div>
    </div>
}
<!-- Alerts for password change and user data update -->
@if (Model.IsPasswordChanged)
{
    <div class="row justify-content-center align-items-center align-content-center"
         style="margin-top: 20px; margin-bottom: 20px">
        <div id="passwordChangedAlert" class="alert alert-success alert-dismissible fade show" role="alert"
             style="display: block;">
            ¡Contraseña cambiada exitosamente!
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
}
@if (Model.IsUserDataUpdated)
{
    <div class="row justify-content-center align-items-center align-content-center"
         style="margin-top: 20px; margin-bottom: 20px">
        <div id="UserDataModifiedAlert" class="alert alert-success alert-dismissible fade show" role="alert"
             style="display: block;">
            ¡Datos modificados exitosamente!
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
}

@if (Model.IsNoLongerModerator)
{
    <div class="row justify-content-center align-items-center align-content-center"
         style="margin-top: 20px; margin-bottom: 20px">
        <div id="DeclineModerationAlert" class="alert alert-success alert-dismissible fade show" role="alert"
             style="display: block;">
            ¡Ha renunciado a su rol de moderador exitosamente!
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
}

@if (Model.IsNowModerator)
{
    <div class="row justify-content-center align-items-center align-content-center"
         style="margin-top: 20px; margin-bottom: 20px">
        <div id="AcceptModerationAlert" class="alert alert-success alert-dismissible fade show" role="alert"
             style="display: block;">
            ¡Ha aceptado el rol de moderador exitosamente!
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
}

<!-- Change Password Modal -->
<div class="modal fade" role="dialog" tabindex="-1" id="ChangePasswordModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="border-radius: 15px; padding: 5px 6px 10px 8px;">
            <div class="modal-header">
                <h4 class="modal-title text-center d-xxl-flex justify-content-xxl-center">
                    Cambiar Mi Contraseña
                </h4>
                <button class="btn-close" type="button" aria-label="Close" data-bs-dismiss="modal"
                        id="CloseChangePasswordButton">
                </button>
            </div>
            <div class="modal-body">
                <form method="post" asp-page-handler="ChangePassword">
                    <div class="text-danger" id="ChangePasswordErrorList">
                        @{
                            var errorMessagesPassword = Model.ChangePasswordModalErrors.GetErrors();
                            foreach (var error in errorMessagesPassword)
                            {
                                <p>@error</p>
                            }
                        }
                    </div>

                    <div class="row">
                        <div class="col">
                            <label class="form-label d-xxl-flex justify-content-xxl-start"
                                   asp-for="PasswordChange.CurrentPassword">
                                Actual Contraseña
                            </label>
                            <input class="form-control" type="password" asp-for="PasswordChange.CurrentPassword"
                                   required>
                            <span asp-validation-for="PasswordChange.CurrentPassword"
                                  class="text-danger">
                            </span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label class="form-label d-xxl-flex justify-content-xxl-start"
                                   asp-for="PasswordChange.NewPassword">
                                Nueva Contraseña
                            </label>
                            <input class="form-control" asp-for="PasswordChange.NewPassword">
                            <span asp-validation-for="PasswordChange.NewPassword" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label class="form-label d-xxl-flex justify-content-xxl-start"
                                   asp-for="PasswordChange.ConfirmNewPassword">
                                Digite la nueva contraseña una vez
                                más
                            </label>
                            <input class="form-control" asp-for="PasswordChange.ConfirmNewPassword">
                            <span asp-validation-for="PasswordChange.ConfirmNewPassword"
                                  class="text-danger">
                            </span>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button class="btn btn-light" type="reset" data-bs-dismiss="modal">Cancelar</button>
                        <button class="btn btn-primary" id ="PostChangePasswordButton" type="submit">Cambiar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Update User Data Modal -->
@{
    var country = await CountryService.Get("Costa Rica");
    var provinces = country.Provinces;
}
<div class="modal fade" role="dialog" tabindex="-1" id="UpdateUserDataModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="border-radius: 15px; padding: 5px 6px 10px 8px;">
            <div class="modal-header">
                <h4 class="modal-title">
                    Modificar Perfil
                </h4>
                <button class="btn-close" type="button" aria-label="Close" data-bs-dismiss="modal"
                        id="CloseUpdateUserButton">
                </button>
            </div>
            <div class="modal-body">
                <form method="post" asp-page-handler="UpdateUserData" id="UpdateUserDataForm">
                    <div class="text-danger" id="UpdateUserModalErrorsList">
                        @{
                            var errorMessagesUpdateData = Model.UpdateUserDataModalErrors.GetErrors();
                            foreach (var error in errorMessagesUpdateData)
                            {
                                <p>@error</p>
                            }
                        }
                    </div>

                    <div class="row">
                        <div class="col">
                            <label class="form-label d-xxl-flex justify-content-xxl-start"
                                   asp-for="UserDataUpdate.Email">
                                Correo Electrónico
                            </label>
                            <input class="form-control" asp-for="UserDataUpdate.Email">
                            <span asp-validation-for="UserDataUpdate.Email" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label asp-for="UserDataUpdate.Province"
                                   class="form-label d-xxl-flex justify-content-xxl-start">
                            </label>
                            <select asp-for="UserDataUpdate.Province" class="form-select"
                                    style="font-family:Roboto, sans-serif; min-width: 210px;">
                                <option value="" disabled selected hidden>Seleccionar</option>
                                @foreach (var province in provinces)
                                {
                                    <option value="@province.Name">@province.Name</option>
                                }
                            </select>

                            <label asp-for="UserDataUpdate.Canton"
                                   class="form-label d-xxl-flex justify-content-xxl-start">
                                Cantón
                            </label>
                            <select asp-for="UserDataUpdate.Canton" class="form-select"
                                    style="font-family:Roboto, sans-serif; min-width: 210px;">
                                <option value="" disabled selected hidden>Seleccionar</option>
                            </select>

                            <label asp-for="UserDataUpdate.ExactAddress"
                                   class="form-label d-xxl-flex justify-content-xxl-start">
                                Dirección exacta
                            </label>
                            <input class="form-control" asp-for="UserDataUpdate.ExactAddress">
                            <span asp-validation-for="UserDataUpdate.ExactAddress" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-light" type="reset" data-bs-dismiss="modal"
                                id="CancelUserUpdateButton">
                            Cancelar
                        </button>
                        <button class="btn btn-primary" type="submit" id="PostUserUpdateButton">Guardar</button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- Decline Moderation Modal -->
@if (Model.IsModerator)
{
    <div class="modal fade" role="dialog" tabindex="-1" id="DeclineModerationRoleModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="border-radius: 15px; padding: 5px 6px 10px 8px;">
                <div class="modal-header">
                    <h4 class="modal-title text-center d-xxl-flex justify-content-xxl-center">
                        Renunciar a Moderación
                    </h4>

                    <button class="btn-close" type="button" aria-label="Close" data-bs-dismiss="modal"
                            id="CloseDeclineModerationRole">
                    </button>
                </div>
                <div class="modal-body">
                    <form method="post" asp-page-handler="DeclineModeration">
                        <div class="row" style>
                            <h5>
                                ¿Está seguro que desea renunciar a su rol de moderador?
                            </h5>
                            <h6>
                                Recuerde que luego de renunciar al rol de moderador, no podrá volver a serlo.
                            </h6>
                        </div>
                        <div class="text-danger" id="DeclineModerationErrorList">
                            @{
                                var errorMessagesDeclineModeration = Model.DeclineModerationModalErrors.GetErrors();
                                foreach (var error in errorMessagesDeclineModeration)
                                {
                                    <p>@error</p>
                                }
                            }
                        </div>
                        <div class="row">
                            <div class="col">
                                <label class="form-label d-xxl-flex justify-content-xxl-start"
                                       asp-for="DeclineRoleUpdate.CurrentPassword">
                                    Digite su contraseña actual para dejar de ser moderador
                                </label>
                                <input class="form-control" type="password" asp-for="DeclineRoleUpdate.CurrentPassword"
                                       required>
                                <span asp-validation-for="DeclineRoleUpdate.CurrentPassword"
                                      class="text-danger">
                                </span>
                            </div>
                        </div>


                        <div class="modal-footer">
                            <button class="btn btn-light" type="reset" data-bs-dismiss="modal">Cancelar</button>
                            <button class="btn btn-primary critical-button" type="submit">Dejar el rol</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="DeclineModalErrors"
         data-has-errors="@Model.DeclineModerationModalErrors.HasErrors.ToString().ToLower()">

    </div>
}

<!-- Acquire Moderation Modal -->
@if (Model.IsPossibleModerator)
{
    <div class="modal fade" role="dialog" tabindex="-1" id="AcquireModerationRoleModal" style="display: block;" aria-modal="true" aria-hidden="false">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content" style="border-radius: 15px; padding: 5px 6px 10px 8px;">
                <div class="modal-body">
                    <h4 class="text-center">
                        Ha sido seleccionado para ser moderador.

                        ¿Desea adquirir el rol de moderador?
                    </h4>
                </div>
                <div class="text-center mb-3">
                    <form method="post" asp-page-handler="DecideOnModeratorRole">
                        <button class="btn btn-danger me-4" style="width: 120px" type="submit" name="decision" value="false" data-bs-dismiss="modal">Rechazar</button>
                        <button class="btn btn-success ms-4" style="width: 120px" type="submit" name="decision" value="true" data-bs-dismiss="modal">Aceptar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
}

</div>
<div id="ChangePasswordModalErrors"
     data-has-errors="@Model.ChangePasswordModalErrors.HasErrors.ToString().ToLower()">
</div>
<div id="UpdateUserModalErrors"
     data-has-errors="@Model.UpdateUserDataModalErrors.HasErrors.ToString().ToLower()">
</div>

@section Scripts {
    <script src="~/lib/jquery/jquery.min.js"></script>
    <script src="~/assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <script type="module" src="~/js/profile/profile.js"></script>
    <link rel="stylesheet" href="~/css/profile.css">
}

</div>